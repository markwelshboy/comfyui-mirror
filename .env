#!/usr/bin/env bash
# ======================================================================
# ComfyUI Vast-AI Environment Configuration
# ======================================================================

# ----- Core -----
export DEBIAN_FRONTEND=noninteractive
export PATH="/opt/venv/bin:$PATH"
export PY="/opt/venv/bin/python"
export PIP="/opt/venv/bin/pip"

# ----- Project Paths -----
export REPO_ROOT="/workspace/comfyui-mirror"
export COMFY_HOME="/workspace/ComfyUI"
export COMFY=$COMFY_HOME
export COMFYUI_PATH=$COMFY_HOME
export COMFY_LOGS="/workspace/logs"
export CUSTOM_DIR="$COMFY_HOME/custom_nodes"
export CUSTOM_LOG_DIR="${COMFY_LOGS}/custom_nodes"
export CACHE_DIR="$COMFY_HOME/cache"
export OUTPUT_DIR="$COMFY_HOME/output"
export BUNDLES_DIR="$COMFY_HOME/bundles"
export WORKFLOW_DIR="$COMFY_HOME/user/default/workflows"

# ----- Python / pip -----
export PIP_NO_INPUT=1
export PIP_DISABLE_PIP_VERSION_CHECK=1
export PIP_NO_CACHE_DIR=1
export NUMPY_VER="numpy>=2.2,<2.3"
export CUPY_VER="cupy-cuda12x>=13.6.0"
export OPENCV_VER="opencv-contrib-python==4.12.0.88"
cat > /workspace/pins.txt <<EOF
${NUMPY_VER}
${CUPY_VER}
${OPENCV_VER}
EOF
export PIP_CONSTRAINT=/workspace/pins.txt

# ----- Git repo URL for ComfyUI / Hearmeman24 -----
export REPO_URL="https://github.com/comfyanonymous/ComfyUI"
export HEARMEMAN_REPO="https://github.com/Hearmeman24/comfyui-wan.git"

# ----- Hugging Face (mirror storage) -----
export HF_REPO_ID="markwelshboyx/hearmemanAI-comfyUI-workflows"
export HF_REPO_TYPE="${HF_REPO_TYPE:-dataset}" # or model
export CN_BRANCH="${CN_BRANCH:-main}"
export HF_TOKEN="${HF_TOKEN:-}"   # set manually or inject from Vast
export HF_API_BASE="https://huggingface.co"

# Auth mode (default = auto)
export HF_AUTH_MODE=auto   # probe â†’ only send token on 401/403
# export HF_AUTH_MODE=always # always send token for huggingface.co
# export HF_AUTH_MODE=never  # never send token

# HF-specific concurrency (fallbacks to global SPLIT/MCONN/CHUNK)
export HF_SPLIT=8
export HF_MCONN=4
export HF_CHUNK=4M

# Probe tuning (defaults are fine)
# export HF_PROBE_TIMEOUT=5
# export HF_PROBE_REDIRECTS=5
# export HF_PROBE_RETRY=0

# Logical set name; controls which family of bundles we fetch/publish
export BUNDLE_TAG="${BUNDLE_TAG:-Wan2_1__Wan2_2__CUDA_12_8}"

# ----- GPU Detection -----
# Pull name(s) from nvidia-smi and classify
GPU_NAME="$(nvidia-smi --query-gpu=name --format=csv,noheader | head -n1 | tr '[:space:]' '_')"
export GPU_NAME
export GPU_COUNT="$(nvidia-smi -L | wc -l)"

case "$GPU_NAME" in
  *L40S*|*L4*|*RTX_6000_ADA*)
      export GPU_ARCH="sm_89"
      export SAGE_COMMIT="68de379"          # proven stable on Ada/L40S
      export TORCH_INDEX="https://download.pytorch.org/whl/nightly/cu128"
      ;;
  *A100*|*H100*|*A800*|*H800*)
      export GPU_ARCH="sm_90"
      export SAGE_COMMIT="68de379"          # still valid; performs well
      export TORCH_INDEX="https://download.pytorch.org/whl/nightly/cu128"
      ;;
  *3090*|*4090*|*A40*|*A5000*)
      export GPU_ARCH="sm_86"
      export SAGE_COMMIT="68de379"
      export TORCH_INDEX="https://download.pytorch.org/whl/nightly/cu121"
      ;;
  *)
      export GPU_ARCH="sm_89"
      export SAGE_COMMIT="68de379"
      export TORCH_INDEX="https://download.pytorch.org/whl/nightly/cu128"
      ;;
esac

# ----- SageAttention build flags -----
export NVCC_APPEND_FLAGS="--threads 8"
export EXT_PARALLEL=4
export MAX_JOBS=32

export PUSH_SAGE_BUNDLE="${PUSH_SAGE_BUNDLE:-0}"  # 1=push after build, 0=skip push

# ----- CUDA tuning -----
export CUDA_VISIBLE_DEVICES="${CUDA_VISIBLE_DEVICES:-0}"
export TORCH_CUDA_ARCH_LIST="$GPU_ARCH"
export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"

# ----- Ports -----
export PORT_MAIN=8188
export PORT_GPU0=8288
export PORT_GPU1=8388
export PORT_JUPYTER=8888

# ----- Misc -----
export TMUX_TMPDIR="/tmp/tmux"
export BASH_ENV="$REPO_ROOT/helpers.sh"    # auto-load helper functions
export COMFY_ENV_TAG="$(date +%Y%m%d_%H%M)_${GPU_NAME}_${GPU_COUNT}GPU"
export LOGFILE_BOOTSTRAP="/workspace/bootstrap_run.log"
export MAX_NODE_JOBS="${MAX_NODE_JOBS:-16}"         # parallelism cap
export GIT_DEPTH="${GIT_DEPTH:-1}"                 # 0 means full; 1 is shallow

# ======================================================================
# Custom Nodes to Install by Default - No other method set (build/list)
# ======================================================================

# -- Default/fallback nodes (must be exported before helpers that resolve lists)
export DEFAULT_NODES=(
  https://github.com/ssitu/ComfyUI_UltimateSDUpscale.git
  https://github.com/ltdrdata/ComfyUI-Impact-Pack.git
  https://github.com/chflame163/ComfyUI_LayerStyle.git
  https://github.com/chflame163/ComfyUI_LayerStyle_Advance.git
  https://github.com/kijai/ComfyUI-KJNodes.git
  https://github.com/rgthree/rgthree-comfy.git
  https://github.com/JPS-GER/ComfyUI_JPS-Nodes.git
  https://github.com/Suzie1/ComfyUI_Comfyroll_CustomNodes.git
  https://github.com/Jordach/comfy-plasma.git
  https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git
  https://github.com/bash-j/mikey_nodes.git
  https://github.com/Fannovel16/comfyui_controlnet_aux.git
  https://github.com/yolain/ComfyUI-Easy-Use.git
  https://github.com/kijai/ComfyUI-Florence2.git
  https://github.com/ShmuelRonen/ComfyUI-LatentSyncWrapper.git
  https://github.com/WASasquatch/was-node-suite-comfyui.git
  https://github.com/theUpsider/ComfyUI-Logic.git
  https://github.com/cubiq/ComfyUI_essentials.git
  https://github.com/chrisgoringe/cg-image-picker.git
  https://github.com/chrisgoringe/cg-use-everywhere.git
  https://github.com/kijai/ComfyUI-segment-anything-2.git
  https://github.com/ClownsharkBatwing/RES4LYF
  https://github.com/welltop-cn/ComfyUI-TeaCache.git
  https://github.com/Fannovel16/ComfyUI-Frame-Interpolation.git
  https://github.com/Jonseed/ComfyUI-Detail-Daemon.git
  https://github.com/kijai/ComfyUI-WanVideoWrapper.git
  https://github.com/BadCafeCode/masquerade-nodes-comfyui.git
  https://github.com/1038lab/ComfyUI-RMBG.git
  https://github.com/M1kep/ComfyLiterals.git
  https://github.com/wildminder/ComfyUI-VibeVoice.git
  https://github.com/kijai/ComfyUI-WanAnimatePreprocess.git
)

export PUSH_CUSTOM_BUNDLE="${PUSH_CUSTOM_BUNDLE:-0}"  # 1=push after install, 0=skip push

# ======================================================================
# ComfyUI ARIA2-Based Downloader Environment Variables
# ======================================================================

# --- Where to pull the manifest ---
export MODEL_MANIFEST_URL=https://raw.githubusercontent.com/markwelshboy/comfyui-mirror/main/model_manifest.json

# Where to store GIDs for "this run"
export ARIA2_GID_FILE="${ARIA2_GID_FILE:-/tmp/.aria2_enqueued_gids}"
export ARIA2_GID_DEBUG=0              # 1=enable gid debug output

# --- Aria2 RPC ---
export ARIA2_HOST=127.0.0.1
export ARIA2_PORT=6969
export ARIA2_SECRET=KissMeQuick       # optional, recommended

# --- Performance knobs ---
export ARIA2_MAX_CONC=8
export ARIA2_SPLIT=16
export ARIA2_MCONN=8
export ARIA2_CHUNK=1M
export ARIA2_FALLOC=none

# --- Aria2 Progress/Checking ---
export ARIA2_PROGRESS_INTERVAL=10     # seconds between snapshots
export ARIA2_PROGRESS_BAR_WIDTH=40
export ARIA2_NAME_COL_WIDTH=56        # width of name column
export ARIA2_PROGRESS_CLEAR=0         # 0 append to log, 1 clear on TTY only
export ARIA2_PROBE=1                  # 1=enable 0=disable light probe
export ARIA2_PROBE_RETRIES=0
export ARIA2_PROBE_DELAY=1
export ARIA2_PROBE_TIMEOUT=10
export ARIA2_SHUTDOWN_ON_INT=1        # 1=stop aria2 on SIGINT, 0=ignore

# Define model paths
export CHECKPOINTS_DIR="$COMFY_HOME/models/checkpoints"
export DIFFUSION_MODELS_DIR="$COMFY_HOME/models/diffusion_models"
export TEXT_ENCODERS_DIR="$COMFY_HOME/models/text_encoders"
export CLIP_VISION_DIR="$COMFY_HOME/models/clip_vision"
export VAE_DIR="$COMFY_HOME/models/vae"
export LORAS_DIR="$COMFY_HOME/models/loras"
export DETECTION_DIR="$COMFY_HOME/models/detection"
export CTRL_DIR="$COMFY_HOME/models/controlnet/SDXL/controlnet-union-sdxl-1.0"
export UPSCALE_DIR="$COMFY_HOME/models/upscale_models"

# --- Section toggles (enable any of these) ---
#download_native_480p=false
#download_native_720p=false
#download_wan22=false
#download_wan22_lightning=true
#download_vace=false
#download_wan_animate=false
#download_clip=true
#download_vae=true
#download_detection=false
#download_optimization_loras=false
#download_wan_fun_and_sdxl_helper=false

# --- CivitAi Specific ---
export CIVITAI_TOKEN="${CIVITAI_TOKEN:-}"                                             # set manually or inject from Vast
export CHECKPOINT_IDS_TO_DOWNLOAD="${CHECKPOINT_IDS_TO_DOWNLOAD:-replace_with_ids}"   
export LORAS_IDS_TO_DOWNLOAD="${LORAS_IDS_TO_DOWNLOAD:-replace_with_ids}"             
export CIVITAI_LOG_DIR="${COMFY_LOGS:-/workspace/logs/civitai}"
export CIVITAI_DEBUG="${CIVITAI_DEBUG:-0}"                                            # 1=enable debug output 

# ----- Convenience echo -----
echo "======================================="
echo "ðŸ§  ComfyUI Environment Loaded"
echo "======================================="
echo "GPU:                  $GPU_NAME ($GPU_COUNT GPU[s])"
echo "SageAttention commit: $SAGE_COMMIT"
echo "Torch index:          $TORCH_INDEX"
echo ""
echo "COMFY_HOME:           $COMFY_HOME"
echo "COMFY_LOGS:           $COMFY_LOGS"
echo ""
echo "Custom nodes dir:     $CUSTOM_DIR"
echo "Logs dir:             $COMFY_LOGS"
echo "Bundles dir:          $BUNDLES_DIR"
echo "Bundle tag:           $BUNDLE_TAG"
echo "Workflow dir:         $WORKFLOW_DIR"
echo "Model manifest URL:   $MODEL_MANIFEST_URL"
echo ""
echo "DIFFUSION_MODELS_DIR: $DIFFUSION_MODELS_DIR"
echo "TEXT_ENCODERS_DIR:    $TEXT_ENCODERS_DIR"
echo "CLIP_VISION_DIR:      $CLIP_VISION_DIR"
echo "VAE_DIR:              $VAE_DIR"
echo "LORAS_DIR:            $LORAS_DIR"
echo "DETECTION_DIR:        $DETECTION_DIR"
echo "CTRL_DIR:             $CTRL_DIR"
echo "UPSCALE_DIR:          $UPSCALE_DIR"
echo ""
echo "HF_TOKEN:             $(if [ -n "$HF_TOKEN" ]; then echo "Set"; else echo "Not set"; fi)"
echo "HF Repo (Type):       $HF_REPO_ID ($HF_REPO_TYPE)"
echo ""
echo "CIVITAI_TOKEN:        $(if [ -n "$CIVITAI_TOKEN" ]; then echo "Set"; else echo "Not set"; fi)"
echo "CHECKPOINT_IDS:       ${CHECKPOINT_IDS_TO_DOWNLOAD:-Empty}"
echo "LORAS_IDS:            ${LORAS_IDS_TO_DOWNLOAD:-Empty}"
echo "======================================="