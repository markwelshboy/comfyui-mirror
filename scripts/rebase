#!/usr/bin/env bash
set -euo pipefail

REPO="/workspace/$(basename `git rev-parse --show-toplevel`)"

source_if_exists() {
  local f="$1"
  [[ -f "$f" ]] || return 0
  echo "[source-if-exists] Sourcing $f ..."
  # shellcheck disable=SC1090
  source "$f"
}

if [[ ! -d "${REPO}/.git" ]]; then
  echo "[rebase] No git repo at ${REPO}"
  exit 1
fi

cd "${REPO}"

branch="$(git rev-parse --abbrev-ref HEAD || echo main)"
echo "[rebase] Updating branch ${branch}â€¦"
git fetch --all --prune
if ! git pull --rebase --autostash; then
  echo "[rebase] Pull/rebase failed, attempting rebase --abort"
  git rebase --abort || true
  exit 1
fi

# Reload env and helpers
source_if_exists "${REPO}/.env"
source_if_exists "${REPO}/helpers.sh"

type -t show_env            >/dev/null 2>&1 && show_env             || true

echo "[rebase] done."